### MLC LLM Android 构建指南（Windows + Ubuntu VM 实测）

本文记录在 Windows 10 + Android NDK + Miniconda + MSVC 工具链环境中，构建 MLCChat 安卓应用的完整步骤。考虑到 Windows 上夜版 LLVM 的兼容性问题，本文采用“在 Ubuntu 虚拟机编译模型库 .tar，回到 Windows 打包 APK（禁止 JIT）”的稳妥路径。同时总结了关键排错要点。

---

### 获取源码与初始化子模块（必做）

在开始构建前，先获取仓库并初始化所有子模块；这一步缺失会导致 `3rdparty/tvm`、`3rdparty/tokenizers-cpp` 等目录不完整，从而在 CMake 阶段报错（如“不含 CMakeLists.txt”“Unknown CMake command tvm_file_glob”）。

Windows / Linux 通用命令：

```bash
git clone https://github.com/mlc-ai/mlc-llm.git
cd mlc-llm
git lfs install
git submodule sync --recursive
git submodule update --init --recursive
```

可选校验（应能看到两个 CMakeLists.txt）：

```bash
# Windows（PowerShell/CMD 亦可用等价 dir）
type 3rdparty/tvm/CMakeLists.txt
type 3rdparty/tokenizers-cpp/CMakeLists.txt
```

---

### 一、准备环境（Windows）

#### 安装 Miniconda（未安装时）

Windows 上推荐使用 Miniconda 管理 Python 环境：

```cmd
:: 方式 A：使用 winget 一键安装
winget install Anaconda.Miniconda3 -s winget --accept-package-agreements --accept-source-agreements

:: 方式 B：手动安装（可选）
:: 访问 https://repo.anaconda.com/miniconda/ 下载最新 x86_64 安装包双击安装
```

初始化与验证（首次安装后）：

```cmd
:: 让 conda 支持当前 shell（可选）
"%USERPROFILE%\miniconda3\Scripts\conda.exe" init cmd.exe
:: 关闭当前窗口，重新打开一个新的 cmd

:: 验证可用性
conda -V
```

如遇 ToS 提示（企业/新装常见），按提示接受一次即可：

```cmd
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r
conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/msys2
```

> 本文其余步骤使用 `call "%USERPROFILE%\miniconda3\Scripts\activate.bat" mlc-android` 的方式激活环境，即使未执行 `conda init` 也可正常使用。

#### 每次新开 cmd 初始化（必做）

新开一个 cmd 窗口后，需按下列顺序完成最小初始化（会话级生效）：

```cmd
:: 1) 激活 conda 环境
call "%USERPROFILE%\miniconda3\Scripts\activate.bat" mlc-android

:: 2) 载入 MSVC 工具链，并避免被 mingw 的 link 抢占
call "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build\vcvars64.bat"
set "PATH=%PATH:C:\Users\kavin\miniconda3\envs\mlc-android\Library\mingw64\bin;=%"
set "PATH=%PATH:C:\Users\kavin\miniconda3\envs\mlc-android\Library\usr\bin;=%"
set LINK=
where link

:: 3) 本会话环境变量（按你的实际路径）
set JAVA_HOME=D:\tools\jdks\ms-17.0.16
set ANDROID_NDK=D:\tools\SDK\ndk\27.0.11718014
set TVM_NDK_CC=%ANDROID_NDK%\toolchains\llvm\prebuilt\windows-x86_64\bin\aarch64-linux-android24-clang.cmd
set TVM_SOURCE_DIR=C:\Users\kavin\Desktop\LLM\mlc-llm\3rdparty\tvm
set MLC_LLM_SOURCE_DIR=C:\Users\kavin\Desktop\LLM\mlc-llm
set MLC_JIT_POLICY=READONLY
```

常用构建命令（进入工程目录后执行）：

```cmd
:: 只读打包（使用 dist\lib 下的 *.tar，不触发 JIT）
cd /d C:\Users\kavin\Desktop\LLM\mlc-llm\android\MLCChat
python -m mlc_llm package

:: 构建并安装 APK 到设备
gradlew.bat assembleDebug
gradlew.bat installDebug
```

- Rust（用于交叉编译 tokenizer，已在实践中需要）
    - 安装：`winget install Rustlang.Rustup -s winget --accept-package-agreements --accept-source-agreements`
    - 验证：`rustc -V`、`cargo -V`、`rustup -V`
    - 添加 Android 目标：`rustup target add aarch64-linux-android`

- Android Studio + NDK（推荐 NDK 27.0.11718014）
    - 设置：
        - `ANDROID_NDK=D:\tools\SDK\ndk\27.0.11718014`
        - `TVM_NDK_CC=%ANDROID_NDK%\toolchains\llvm\prebuilt\windows-x86_64\bin\aarch64-linux-android24-clang.cmd`

- JDK 17（使用无空格路径）
    - 示例：`JAVA_HOME=D:\tools\jdks\ms-17.0.16` (Android Studio自带的jdk)
    - 验证：`"%JAVA_HOME%\bin\java" -version`

- Miniconda + 依赖
    - 安装 Miniconda：`winget install Anaconda.Miniconda3 -s winget --accept-package-agreements --accept-source-agreements`
    - 初始化并创建环境：
        - `call "%USERPROFILE%\miniconda3\Scripts\activate.bat"`
        - `conda create -n mlc-android python=3.13 -y`
        - `call "%USERPROFILE%\miniconda3\Scripts\activate.bat" mlc-android`
    - 安装 Python 轮子与本地依赖：
        - `python -m pip install --pre -U -f https://mlc.ai/wheels mlc-llm-nightly-cpu mlc-ai-nightly-cpu`
        - `conda install -c conda-forge zstd clang libvulkan-loader git git-lfs cmake ninja -y`

- MSVC 构建工具（提供 link.exe）
    - 安装：
        - `winget install Microsoft.VisualStudio.2022.BuildTools --accept-package-agreements --accept-source-agreements --override "--quiet --wait --norestart --add Microsoft.VisualStudio.Workload.VCTools --includeRecommended --includeOptional"`
    - 载入 VS 环境：
        - `call "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build\vcvars64.bat"`
        - `call "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools\VC\Auxiliary\Build\vcvars64.bat"`(应该是单斜杠)
    - 避免 mingw 的 link 抢占（本会话 PATH 清理）：
        - `set "PATH=%PATH:C:\Users\<you>\miniconda3\envs\mlc-android\Library\mingw64\bin;=%"`
        - `set "PATH=%PATH:C:\Users\kavin\miniconda3\envs\mlc-android\Library\mingw64\bin;=%"`(我自己的路径,应该是单斜杠)
        - `set "PATH=%PATH:C:\Users\<you>\miniconda3\envs\mlc-android\Library\usr\bin;=%"`(移除 conda usr\bin 的 link 干扰，并校验)
        - `set "PATH=%PATH:C:\Users\kavin\miniconda3\envs\mlc-android\Library\usr\bin;=%"`(我自己的路径,应该是单斜杠)
        - `where link`（仅应看到 VS 的 link.exe）
    - 切勿将 `LINK` 环境变量设置为“带空格的可执行路径”。若误设，清除：`set LINK=`

> 每次新开 cmd 窗口需：激活 conda 环境、载入 vcvars64.bat、重设上述环境变量（均为会话级）。

---

### 二、在 Ubuntu 22.04（VM/WSL2）编译模型库 .tar（推荐）

Windows 夜版编译器与 LLVM 调试信息在部分组合下会触发 `dbg_declare` 校验错误。建议在 Linux 侧生成 Android 模型库 .tar，再回到 Windows 打包 APK。

1) 依赖与环境

```bash
sudo apt update
sudo apt install -y git git-lfs build-essential cmake ninja-build clang curl zstd
git lfs install

# Miniconda 或 venv 二选一
# Miniconda
wget -O ~/miniconda.sh https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash ~/miniconda.sh -b -p $HOME/miniconda3
eval "$($HOME/miniconda3/bin/conda shell.bash hook)"
conda create -n mlc-android python=3.13 -y && conda activate mlc-android

python -m pip install --pre -U -f https://mlc.ai/wheels mlc-llm-nightly-cpu mlc-ai-nightly-cpu

# 如需代理/镜像（可选）
export http_proxy=http://127.0.0.1:7897
export https_proxy=http://127.0.0.1:7897
export HF_ENDPOINT=https://hf-mirror.com
```

2) 使用 git-lfs 完整克隆权重（避免 Python SSL 下载中断）

```bash
cd ~/Desktop/LLM
git lfs install
git clone https://huggingface.co/mlc-ai/Qwen3-0.6B-q0f16-MLC
```

3) 本地目录编译为 Android 模型库 .tar

```bash
python -m mlc_llm compile ~/Desktop/LLM/Qwen3-0.6B-q0f16-MLC \
  --device android \
  --overrides "prefill_chunk_size=128;context_window_size=2048" \
  --output ~/qwen3-0p6b-android.tar
```

4) 将生成的 `qwen3-0p6b-android.tar` 拷贝到 Windows 目录：

```
C:\Users\kavin\Desktop\LLM\mlc-llm\android\MLCChat\dist\lib\
```

#### 附：示例 - 编译 Phi-3.5-mini-instruct-q4f16_0-MLC

```bash
# 1) 克隆模型（已在父目录，如 ~/Desktop/LLM）
cd ~/Desktop/LLM
git lfs install
git clone https://huggingface.co/mlc-ai/Phi-3.5-mini-instruct-q4f16_0-MLC

# 2) 编译为 Android 模型库 .tar（与 test.json 一致的 overrides）
#   可在克隆父目录执行相对路径，也可用绝对路径
python -m mlc_llm compile ./Phi-3.5-mini-instruct-q4f16_0-MLC \
  --device android \
  --overrides "prefill_chunk_size=128" \
  --output ./phi3p5-mini-android.tar

# 3) 将生成的 .tar 拷贝回 Windows 的 dist/lib 目录
#   例如 WSL→Windows：
cp ./phi3p5-mini-android.tar /mnt/c/Users/kavin/Desktop/LLM/mlc-llm/android/MLCChat/dist/lib/
```

> 编译日志会显示自动推断的 `--system-lib-prefix`，如 `phi3_q4f16_0_`。在 `mlc-package-config.json` 中应填写 `model_lib: "phi3_q4f16_0"`（去掉末尾下划线），并保持 `.tar` 文件名与日志推断前缀的一致性（不要随意改名）。

---

### 三、配置应用并打包（Windows，禁止 JIT）

1) `mlc-package-config.json`（以 Qwen3 0.6B 为例）

```json
{
  "device": "android",
  "model_list": [
    {
      "model": "HF://mlc-ai/Qwen3-0.6B-q0f16-MLC",
      "model_id": "Qwen3-0.6B-q0f16-MLC",
      "estimated_vram_bytes": 3000000000,
      "model_lib": "qwen3_q0f16",
      "overrides": { "prefill_chunk_size": 128, "context_window_size": 2048 }
    }
  ],
  "model_lib_path_for_prepare_libs": {
    "qwen3_q0f16": "dist/lib/qwen3-0p6b-android.tar"
  }
}
```

> `model_lib` 必须匹配 .tar 内部的 system-lib 前缀（Qwen3 为 `qwen3_q0f16_`，去掉结尾下划线后写入）。

#### 示例：同时配置 Qwen3 与 Phi-3.5

```json
{
  "device": "android",
  "model_list": [
    {
      "model": "HF://mlc-ai/Qwen3-0.6B-q0f16-MLC",
      "model_id": "Qwen3-0.6B-q0f16-MLC",
      "estimated_vram_bytes": 3000000000,
      "model_lib": "qwen3_q0f16",
      "overrides": { "prefill_chunk_size": 128, "context_window_size": 2048 }
    },
    {
      "model": "HF://mlc-ai/Phi-3.5-mini-instruct-q4f16_0-MLC",
      "model_id": "Phi-3.5-mini-instruct-q4f16_0-MLC",
      "estimated_vram_bytes": 4250586449,
      "model_lib": "phi3_q4f16_0",
      "overrides": { "prefill_chunk_size": 128 }
    }
  ],
  "model_lib_path_for_prepare_libs": {
    "qwen3_q0f16": "dist/lib/qwen3-0p6b-android.tar",
    "phi3_q4f16_0": "dist/lib/phi3p5-mini-android.tar"
  }
}
```

2) 只读打包（使用已有 .tar，完全禁止 JIT）

```cmd
cd /d C:\Users\kavin\Desktop\LLM\mlc-llm\android\MLCChat
set MLC_JIT_POLICY=READONLY
python -m mlc_llm package
```

执行成功后会生成 `dist\lib\mlc4j\` 子工程，包含：
- `output\arm64-v8a\libtvm4j_runtime_packed.so`
- `tvm4j_core.jar`
- `src\main\assets\mlc-app-config.json`

3) 构建并安装 APK

```cmd
gradlew.bat assembleDebug
adb devices
gradlew.bat installDebug
```

> 需物理设备（模拟器不支持有效 GPU 加速）。

---

### 四、可选：将权重打入 APK 并推送到手机

1) 在目标模型加入：`"bundle_weight": true`，然后：

```cmd
python -m mlc_llm package
gradlew.bat assembleRelease
python .\bundle_weight.py --apk-path app\release\app-release.apk
```

---

### 五、常见问题与排错

- Windows 上 LLVM 校验 `dbg_declare` 错误
    - 解决：采用 Ubuntu/WSL2 编译 .tar 的方案；或尝试 `set TVM_LLVM_OPTIONS=-debug-info-kind=none` 后再编译（不一定适配所有夜版）。

- `vswhere.exe not found` / `ninja -v` 相关告警
    - 属可选扩展构建失败的告警，不影响主流程；如需消除：
        - `winget install Microsoft.VisualStudio.WhereIs -s winget --accept-package-agreements --accept-source-agreements`

- Cargo 误用非 MSVC 的 `link.exe`
    - 启动 VS 环境：`vcvars64.bat`
    - 清理本会话 PATH 中的 `mingw64\bin`、`Library\usr\bin`
    - 避免设置 `LINK` 为“带空格的可执行路径”；如误设，执行 `set LINK=`
    - 如需，显式指定：`set CARGO_TARGET_X86_64_PC_WINDOWS_MSVC_LINKER=link.exe`

- Git/HF 下载 SSL/网络问题
    - Windows：`git config --global http.sslbackend schannel`
    - Ubuntu：默认 gnutls，勿改 openssl；必要时 `git -c http.sslVerify=false clone ...` 仅用于排错
    - Python 侧：可设置 `http_proxy/https_proxy/HF_ENDPOINT` 并重试

---

### 六、参考

- 官方文档：`https://llm.mlc.ai/docs/deploy/android.html`
- 相关发布页（Python 轮子）：`https://github.com/mlc-ai/package/releases`


